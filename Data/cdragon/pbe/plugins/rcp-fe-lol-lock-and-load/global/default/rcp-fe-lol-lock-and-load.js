(()=>{var e=[,e=>{"use strict";let t;function o(){return t||(console.error("The `provider` object has not been set, please do so by calling the `init` method."),null)}const n={init:function(e,o){return t=e,this.add(o)},_getValue:function(e,o){let n;return"function"==typeof o?(n=o(t),n||console.warn("The function for key "+e+" returned a falsy value: ",n)):"string"==typeof o?(n=t.get(o),n||console.warn("The provider `get` invocation for the key "+e+" returned a falsy value: ",n)):"object"==typeof o&&(n=o),n},add:function(e){e=e||{};const t=[],o=this;return Object.keys(e).forEach((function(n){const s=e[n],i=o._getValue(n,s);i&&i.then?(i.then((function(e){e||console.warn("The promise for the key "+n+" resolved with a falsy value: ",e),o._addValue(n,e)})),t.push(i)):o._addValue(n,i)})),Promise.all(t)},_addValue:function(e,t){this[e]=t},provider:function(){return console.error("The function `provider` has been deprecated, please use `getProvider`",(new Error).stack),o()},getProvider:function(){return o()}};e.exports=n},(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(){const e=new s.default;return new n.default(e)};var n=i(o(3)),s=i(o(5));function i(e){return e&&e.__esModule?e:{default:e}}},(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,s=(n=o(4))&&n.__esModule?n:{default:n};let i=null;t.default=class{constructor(e){i=e}initializeStartupLocks(){i.initializeStartupLocks()}lockAndLoad(e){return i.lockAndLoad(e)}addEventListener(...e){return s.default.addEventListener(...e)}removeEventListener(...e){return s.default.removeEventListener(...e)}hasEventListener(...e){return s.default.hasEventListener(...e)}getLockState(){return i.isLocked}get isLocked(){return i.isLocked}set isLocked(e){throw new Error("Attempted to set rcp-fe-lol-lock-and-load.isLocked, which is read-only")}}},function(e){var t;e.exports=(t={},(t=function(){this.listeners={}}).prototype={addEventListener:function(e,t,o){for(var n=[],s=arguments.length,i=0;i<s;i++)n.push(arguments[i]);n=n.length>3?n.splice(3,n.length-1):[],void 0!==this.listeners[e]?this.listeners[e].push({scope:o,callback:t,args:n}):this.listeners[e]=[{scope:o,callback:t,args:n}]},removeEventListener:function(e,t,o){if(void 0!==this.listeners[e]){for(var n=this.listeners[e].length,s=[],i=0;i<n;i++){var a=this.listeners[e][i];a.scope==o&&a.callback==t||s.push(a)}this.listeners[e]=s}},hasEventListener:function(e,t,o){if(void 0!==this.listeners[e]){var n=this.listeners[e].length;if(void 0===t&&void 0===o)return n>0;for(var s=0;s<n;s++){var i=this.listeners[e][s];if((!o||i.scope==o)&&i.callback==t)return!0}}return!1},dispatch:function(e,t){for(var o={type:e,target:t},n=[],s=arguments.length,i=0;i<s;i++)n.push(arguments[i]);if(n=n.length>2?n.splice(2,n.length-1):[],n=[o].concat(n),void 0!==this.listeners[e]){var a=this.listeners[e].slice(),r=a.length;for(i=0;i<r;i++){var l=a[i];if(l&&l.callback){var c=n.concat(l.args);l.callback.apply(l.scope,c)}}}},getEvents:function(){var e="";for(var t in this.listeners)for(var o=this.listeners[t].length,n=0;n<o;n++){var s=this.listeners[t][n];e+=s.scope&&s.scope.className?s.scope.className:"anonymous",e+=" listen for '"+t+"'\n"}return e}},new t)},(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,s=o(1),i=(n=o(4))&&n.__esModule?n:{default:n};const a="/lol-lock-and-load/v1/should-wait-for-home-hubs";t.default=class{constructor(){this.locks=[],this.isLocked=!1}async waitForHomeHubsToLoad(){const e=await s.db.get("/lol-lock-and-load/v1/home-hubs-waits"),t=1e3*(e?.initialWait??5),o=1e3*(e?.additionalWait??0);window.dispatchEvent(new CustomEvent("homeHubsAreLoading",{detail:{stage:"initialWait"}})),await new Promise((e=>setTimeout(e,t))),o>0&&(window.dispatchEvent(new CustomEvent("homeHubsAreLoading",{detail:{stage:"additionalWait"}})),await new Promise((e=>setTimeout(e,o)))),window.dispatchEvent(new CustomEvent("homeHubsAreLoaded",{detail:{timedOut:!0}}))}async initializeStartupLocks(){const e=this.lockAndLoad({lockName:"rcp-fe-lol-lock-and-load:allPluginsLoaded"});s.logger.info("[startup] Waiting for plugins to load"),window.addEventListener("riotPlugin.allPluginsLoaded",(()=>{s.logger.info("[startup] Plugins are loaded"),e(),this.waitForHomeHubsToLoad()}),{once:!0});await s.db.get("/lol-gameflow/v1/session")||s.db.observe(a,this,(e=>{if(!0===e){const e=this.lockAndLoad({lockName:"rcp-fe-lol-lock-and-load:homeHubsLoaded"});s.logger.info("[startup] Waiting for Home Hubs to load"),window.addEventListener("homeHubsAreLoaded",(t=>{t.detail?.timedOut?s.logger.warning("[startup] Home hubs timed out."):s.logger.info("[startup] Home Hubs are loaded"),e()}),{once:!0}),s.db.unobserve(a,this)}}))}lockAndLoad(e={}){const{lockName:t,promise:o,timeout:n}=e,i=[];let a;if(t||s.logger.warning("Lock created with no lockName. This could make debugging difficult in the future."),o?.then)i.push(o);else{const e=new Promise((e=>{a=e}));i.push(e)}if(n){const e=Number.isFinite(n)?n:6e4;if(e>0){const t=new Promise(((t,o)=>{setTimeout(o,e)}));i.push(t)}}const r=Date.now(),l=Promise.race(i);return l.then((()=>{this.unlock(l);const e=Date.now()-r;s.logger.trace("[startup] Lock unlocked",{lockName:t,elapsedTimeMs:e})})).catch((()=>{this.unlock(l);const e=Date.now()-r;s.logger.error("[startup] Lock loader promise rejected. Possible timeout?",{lockName:t,elapsedTimeMs:e})})),this.locks.push(l),this.updateLockedState(),a}unlock(e){const t=this.locks.indexOf(e);t>-1&&this.locks.splice(t,1),this.updateLockedState()}updateLockedState(){this.locks.length>0?this.setLockedState():this.removeLockedState()}setLockedState(){this.isLocked||(this.isLocked=!0,this.wasEverLocked=!0,i.default.dispatch("lock"))}removeLockedState(){this.isLocked&&(this.isLocked=!1,i.default.dispatch("unlock"))}}}],t={};function o(n){var s=t[n];if(void 0!==s)return s.exports;var i=t[n]={exports:{}};return e[n].call(i.exports,i,i.exports,o),i.exports}(()=>{"use strict";var e,t=(e=o(1))&&e.__esModule?e:{default:e};const n="rcp-fe-lol-lock-and-load",s=document.currentScript.ownerDocument;const i=window.getPluginAnnounceEventName(n);s.addEventListener(i,(function(e){(0,e.registrationHandler)((async function(e){await t.default.init(e,{dataBinding:e=>e.get("rcp-fe-common-libs").getDataBinding(n),logger:e=>e.get("rcp-fe-common-libs").logging.create(n),socket:e=>e.getSocket()}),await t.default.add({db:t.default.dataBinding.bindTo(t.default.socket)});const s=(0,o(2).default)();return s.initializeStartupLocks(),s}))}),{once:!0})})()})();
//# sourceMappingURL=rcp-fe-lol-lock-and-load.js.map